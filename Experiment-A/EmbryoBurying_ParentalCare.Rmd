---
title: "EmbryoBurying_ParentalCare"
author: "MB"
date: '2025-11-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

Load required packages

```{r packages, results='hide'}
# Install required packages (run once)
packages <- c("readxl", "lme4", "lmerTest", "emmeans", "ggplot2", "dplyr")
# Check if packages are installed, install if not
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load all packages
library(readxl)      # For reading Excel files
library(lme4)        # For mixed-effects models
library(lmerTest)    # For p-values with Satterthwaite approximation
library(emmeans)     # For post-hoc comparisons
library(ggplot2)     # For visualization
library(dplyr)       # For data manipulation

# Set options
options(prompt = "=")
```

Read your data

```{r data-import}
# Read in excel sheet
data <- read_excel("embryostealing_2021.xlsx")

# View data to check import
head(data)

# Convert categorical variables to factors
data$hpos <- as.factor(data$hpos)
data$vpos <- as.factor(data$vpos)
data$nest <- as.factor(data$nest)

# Check data structure
str(data)
summary(data)

# Check sample sizes for each combination
table(data$hpos, data$vpos)
```
Fit mixed-effects model with nest as random effect

```{r model}
# Model percent survival by pouch location
model <- lmer(percentsurvival ~ hpos * vpos + (1|nest), data = data)

summary(model)

#ANOVA table with F-tests
anova_results <- anova(model)
print(anova_results)

# Check model assumptions
par(mfrow = c(2, 2))
plot(model, main = "Residuals vs Fitted")
qqnorm(resid(model))
qqline(resid(model))
hist(resid(model), main = "Histogram of Residuals", xlab = "Residuals")
plot(fitted(model), sqrt(abs(resid(model))), 
     main = "Scale-Location", xlab = "Fitted values", 
     ylab = "sqrt(|Residuals|)")

#  QQ and residuals normality plots
res <- residuals(model)

res_df <- data.frame(residuals = res)

ggplot(res_df, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = "red", linetype = "dashed") +
  theme_bw() +
  labs(title = "Normal Q-Q Plot of Residuals")

ggplot(res_df, aes(x = residuals)) +
  geom_histogram(aes(y = ..density..), bins = 20, fill = "lightblue", color = "white") +
  geom_density(color = "red", linewidth = 1) +
  theme_bw() +
  labs(title = "Histogram of Residuals", x = "Residuals", y = "Density")


# Calculate means and standard errors
means_table <- data %>%
  group_by(vpos) %>%
  summarise(
    mean = mean(percentsurvival, na.rm = TRUE),
    se = sd(percentsurvival, na.rm = TRUE) / sqrt(n()),
    n = n()
  )
print(means_table)

# Estimated marginal means for main effects and interaction
emmeans_vpos <- emmeans(model, ~ vpos)
print(summary(emmeans_vpos))

emmeans_hpos <- emmeans(model, ~ hpos)
print(summary(emmeans_hpos))

emmeans_interaction <- emmeans(model, ~ hpos * vpos)
print(summary(emmeans_interaction))
```

Post-hoc analysis - Tukey Test

```{r post-hoc analysis}
# Pairwise comparisons for vertical position
pairs_vpos <- pairs(emmeans_vpos, adjust = "tukey")
print(pairs_vpos)

# Pairwise comparisons for horizontal position
pairs_hpos <- pairs(emmeans_hpos, adjust = "tukey")
print(pairs_hpos)

# Pairwise comparisons for interaction
pairs_interaction <- pairs(emmeans_interaction, adjust = "tukey")
print(pairs_interaction)

# Create interaction plot
interaction_plot <- ggplot(data, aes(x = hpos, y = percentsurvival, 
                                      color = vpos, group = vpos)) +
  stat_summary(fun = mean, geom = "point", size = 4) +
  stat_summary(fun = mean, geom = "line", linewidth = 1) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, 
               linewidth = 1) +
  labs(title = "Interaction: Horizontal Ã— Vertical Position on Embryo Survival",
       x = "Horizontal Position",
       y = "Percent Survival",
       color = "Vertical Position") +
  theme_bw(base_size = 14) +
  theme(legend.position = "right")

print(interaction_plot)

boxplot <- ggplot(data, aes(x = hpos, y = percentsurvival, fill = vpos)) + geom_boxplot() +
  theme_bw() + labs(title = "Percent Survival by Horizontal and Vertical Position")

print(boxplot)
```



# Optional: Save the plot
# ggsave("interaction_plot.png", interaction_plot, width = 8, height = 6, dpi = 300)

# Optional: Export results to CSV files
# write.csv(as.data.frame(anova_results), "anova_results.csv", row.names = TRUE)
# write.csv(as.data.frame(summary(emmeans_interaction)), "emmeans_interaction.csv")
# write.csv(as.data.frame(pairs_interaction), "tukey_posthoc.csv")

cat("\n=== ANALYSIS COMPLETE ===\n")